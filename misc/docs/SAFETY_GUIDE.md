# Safety Guide: владение, ссылки, инкапсуляция

Основные принципы:
- Сырые указатели — только в `unsafe` (FFI/оптимизации).
- По умолчанию `Unique` (единоличное владение); `Shared` — осознанно, при реальной нужде.
- Обратные ссылки и наблюдатели — `Weak`/`Handle`, не `Shared`.
- Не-владеющие ссылки — `Observer`/`Span` и только в пределах короткой области.
- Инварианты/инкапсуляция — через приватные поля и фабрики; data-record’ы без инвариантов — с `pub` полями и без методов.

## Типы (см. POINTER_POLICY_STANDARD)
- `Unique`, `Shared`, `Weak`, `Observer`, `Handle`, `Span`, `Optional` (+ при необходимости `Intrusive`, `Pinned`).

## Чеклист при проектировании
- Есть инварианты? → `struct` с `priv` полями; создание через фабрики; `Shared/Weak` по правилам.
- Нет инвариантов (DTO/конфиг)? → data-record с `pub` полями, без методов.
- Обратные ссылки? → `Weak` или `Handle`.
- Граф/ресурсы/кеш? → `Handle` (id+generation), не `Shared` между всеми.
- Подписки/события? → хранить `Weak` на слушателей, возвращать `Subscription` с авто-отпиской.
- Двусторонние отношения? → одна сторона владеет (`Shared`/`Unique`), обратная — `Weak`.
- Нужно стабильный адрес? → `Pinned`/no-move контейнер.
- Нужно разделённое владение? → `Shared`; но следить за циклами (одна сторона `Weak`).

## Линт/стиль (рекомендуется enforce)
- Запрет двустороннего `Shared` в полях одного агрегата (циклы) — одна сторона `Weak`.
- Запрет создавать `Shared` из сырого указателя, если уже есть другой `Shared`.
- Сырые указатели — только в `unsafe`.
- Обратные ссылки в деревьях/иерархиях — помечать `@weak_ref` (или `ParentPtr` алиас).
- Подписки/слушатели — только через слабые ссылки; коллекции слушателей не держат мир.

## Инкапсуляция
- Поля опак-типов — `priv`; экспортируется только тип и публичные методы/фабрики.
- Data-record’ы — `pub` поля, без инвариантов и без “умных” методов; логика — через функции/трейты.
- Модули — граница приватности; `export` явно.

## Примеры паттернов
- Дерево/UI: `children: Shared<Node>[], parent: Weak<Node>`.
- Подписка: `listeners: Weak<Callback>[]`, `Subscription` с авто-отпиской в деструкторе.
- Граф/ресурс: `Handle<T>` (id+gen), `resolve(handle)` → `Option<&T>`/`Option<Shared<T>>`.
- Кеш: хранить `Weak`/`Handle` на клиентов; иначе кеш удерживает всё.
- Двусвязный список: одно направление владеет, обратное — `Weak` или индексы (handle).

## Методы и OO-модель (кратко)
- Методы в `struct/record` с неявным `@`; видимость `pub/priv`.
- Поведение/полиморфизм — через `trait` + `extend Type : Trait { ... }`, без наследования классов.
- Простые данные — `pub` поля, без методов; инварианты — `priv` поля + фабрики.
